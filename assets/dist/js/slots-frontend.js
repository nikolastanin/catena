class l{init(){this.bindEvents()}bindEvents(){document.addEventListener("change",this.handleSortChange.bind(this)),document.addEventListener("change",this.handleLimitChange.bind(this)),document.addEventListener("click",this.handleLoadMore.bind(this)),document.addEventListener("submit",t=>{if(t.target.closest(".slots-container"))return t.preventDefault(),t.stopPropagation(),!1}),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("slots-limit");t&&(t.addEventListener("change",e=>{e.preventDefault(),e.stopPropagation()},!0),t.addEventListener("submit",e=>(e.preventDefault(),e.stopPropagation(),!1)),t.addEventListener("click",e=>{e.stopPropagation()}),t.form&&t.form.addEventListener("submit",e=>(e.preventDefault(),e.stopPropagation(),!1)))})}handleSortChange(t){if(!t.target.classList.contains("slots-sort-select"))return;t.preventDefault(),t.stopPropagation();const e=t.target,a=this.findClosest(e,".slots-container");if(!a)return;const r=e.value,s=a.querySelector(".slots-limit-select"),o=s?s.value:"10";this.reloadSlots(a,{sort:r,limit:o})}handleLimitChange(t){if(!t.target.classList.contains("slots-limit-select"))return;t.preventDefault(),t.stopPropagation();const e=t.target,a=this.findClosest(e,".slots-container");if(!a)return;const r=e.value,s=a.querySelector(".slots-sort-select"),o=s?s.value:"date";a.dataset.limit=r;const n=a.querySelector(".load-more-slots");n&&(n.dataset.limit=r,n.dataset.page="1"),this.reloadSlots(a,{sort:o,limit:r})}reloadSlots(t,e){const a=t.querySelector(".slots-grid");if(a){if(a.innerHTML='<div class="slots-loading">Loading...</div>',!window.slots_ajax||!window.slots_ajax.ajax_url){a.innerHTML='<div class="slots-error">AJAX configuration error. Please refresh the page.</div>';return}this.makeAjaxRequest({url:window.slots_ajax.ajax_url,type:"POST",data:{action:"load_more_slots",nonce:a.dataset.nonce,page:1,limit:parseInt(e.limit),sort:e.sort},success:r=>{if(r.success){const s=window.scrollY;a.innerHTML=r.data.html,window.scrollTo(0,s);const o=t.querySelector(".load-more-slots");r.data.has_more?o&&(o.style.display="block",o.dataset.page="1"):o&&(o.style.display="none")}else{const s=r.data&&r.data.message?r.data.message:window.slots_ajax.strings.error;a.innerHTML='<div class="slots-error">'+s+"</div>"}},error:(r,s,o)=>{let n=window.slots_ajax.strings.error;r.status===403?n="Access denied. Please refresh the page and try again.":r.status===500&&(n="Server error. Please try again later."),a.innerHTML='<div class="slots-error">'+n+"</div>"}})}}loadMoreSlots(t,e,a){const r=t.querySelector(".slots-sort-select"),s=t.querySelector(".slots-limit-select"),o=r?r.value:"date",n=s?parseInt(s.value):10;this.makeAjaxRequest({url:window.slots_ajax.ajax_url,type:"POST",data:{action:"load_more_slots",nonce:t.querySelector(".slots-grid").dataset.nonce,page:e,limit:n,sort:o},success:i=>{i.success?(t.querySelector(".slots-grid").insertAdjacentHTML("beforeend",i.data.html),a(i.data.has_more)):a(!1)},error:(i,c,u)=>{a(!1)}})}handleLoadMore(t){if(!t.target.classList.contains("load-more-slots"))return;t.preventDefault();const e=t.target,a=this.findClosest(e,".slots-container"),s=(parseInt(e.dataset.page)||1)+1;e.disabled=!0,e.textContent="Loading...",this.loadMoreSlots(a,s,o=>{e.dataset.page=s,e.disabled=!1,o?e.textContent="Load More Slots":e.style.display="none"})}findClosest(t,e){for(;t&&t!==document;){if(t.matches&&t.matches(e))return t;t=t.parentElement}return null}makeAjaxRequest(t){const e=new FormData;for(const s in t.data)t.data.hasOwnProperty(s)&&e.append(s,t.data[s]);const a=new AbortController,r=setTimeout(()=>a.abort(),1e4);fetch(t.url,{method:t.type||"POST",body:e,signal:a.signal}).then(s=>{if(clearTimeout(r),!s.ok)throw new Error("HTTP "+s.status+": "+s.statusText);return s.json()}).then(s=>{t.success&&t.success(s)}).catch(s=>{clearTimeout(r);let o="Network error occurred",n=500;if(s.name==="AbortError"?(o="Request timed out",n=408):s.message.includes("Failed to fetch")?(o="Network connection failed. Please check your internet connection.",n=0):s.message.includes("HTTP 403")?(o="Access denied. Please refresh the page and try again.",n=403):s.message.includes("HTTP 500")&&(o="Server error. Please try again later.",n=500),t.error&&typeof t.error=="function"){const i={status:n};t.error(i,"error",o)}})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.Slots=new l,window.Slots.init()}):(window.Slots=new l,window.Slots.init());
